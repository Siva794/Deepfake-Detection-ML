<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deepfake Detector</title>
  <meta name="description" content="Upload one or more images to detect if they are real or AI-generated." />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <!-- Navbar -->
  <nav class="navbar" role="navigation" aria-label="main">
    <div class="nav-title">ğŸ§  Deepfake Detector</div>
  </nav>

  <!-- Main Content -->
  <div class="container">
    <h1 class="subtitle">Detect if your image is AI-generated or real</h1>

    {% if error %}
      <div class="alert alert-error" role="alert">{{ error }}</div>
    {% endif %}

    <form id="uploadForm" action="{{ url_for('predict') }}" method="post" enctype="multipart/form-data">
      <label class="upload-box" id="dropZone">
        <input
          type="file"
          id="file"
          name="file"
          accept=".jpg,.jpeg,.png,.bmp,.webp,image/*"
          multiple
          required
          aria-label="Choose one or more images to analyze"
        />
        <span id="uploadText">ğŸ“ Click or drag multiple images here</span>
        <small class="hint">Allowed: JPG, PNG, BMP, WEBP â€¢ Max ~10 MB total</small>
      </label>

      <div id="previewContainer" class="preview-grid" aria-live="polite"></div>

      <button type="submit" id="detectBtn">ğŸ” Analyze Images</button>
    </form>

    <div id="loader" class="loader" aria-live="assertive" aria-busy="true" hidden>
      <div class="spinner" aria-hidden="true"></div>
      <p>Analyzing images...</p>
    </div>

    {% if results %}
    <section class="results-section" aria-label="analysis results">
      <h2>ğŸ” Results</h2>
      <div class="results-grid">
        {% for r in results %}
        <article class="result-card fade-in">
          <img src="{{ r.path }}" alt="Uploaded image {{ loop.index }}" loading="lazy" decoding="async">
          <div class="label {% if 'Fake' in r.label %}fake{% else %}real{% endif %}">{{ r.label }}</div>
          <div class="conf" aria-label="confidence">
            Real: {{ r.real_conf }}% | Fake: {{ r.fake_conf }}%
          </div>
        </article>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <noscript>
      <p class="noscript">JavaScript is disabled. You can still upload images, but previews and progress will be limited.</p>
    </noscript>
  </div>

  <script>
    (function () {
      const input = document.getElementById('file');
      const form = document.getElementById('uploadForm');
      const previewContainer = document.getElementById('previewContainer');
      const loader = document.getElementById('loader');
      const dropZone = document.getElementById('dropZone');

      // Keep these in sync with server
      const ALLOWED_EXTS = ['.jpg', '.jpeg', '.png', '.bmp', '.webp'];
      const MAX_TOTAL_MB = 10; // matches Flask MAX_CONTENT_LENGTH_MB default
      const MAX_TOTAL_BYTES = MAX_TOTAL_MB * 1024 * 1024;

      function extOf(name) {
        const i = (name || '').lastIndexOf('.');
        return i >= 0 ? name.slice(i).toLowerCase() : '';
      }

      function clearPreviews() {
        // revoke previous object URLs
        for (const img of previewContainer.querySelectorAll('img[data-url]')) {
          URL.revokeObjectURL(img.getAttribute('data-url'));
        }
        previewContainer.innerHTML = '';
      }

      function renderPreviews(files) {
        clearPreviews();
        Array.from(files).forEach((f, idx) => {
          const url = URL.createObjectURL(f);
          const card = document.createElement('div');
          card.className = 'preview-card';
          card.innerHTML = `<img src="${url}" data-url="${url}" alt="preview ${idx + 1}" loading="lazy" decoding="async">`;
          previewContainer.appendChild(card);
        });
      }

      function validateFiles(files) {
        if (!files || !files.length) return { ok: false, message: 'No files selected.' };

        let total = 0;
        for (const f of files) {
          const e = extOf(f.name);
          if (!ALLOWED_EXTS.includes(e)) {
            return { ok: false, message: `Unsupported file: ${f.name}. Allowed: ${ALLOWED_EXTS.join(', ')}` };
          }
          total += f.size || 0;
        }
        if (total > MAX_TOTAL_BYTES) {
          return { ok: false, message: `Total upload size exceeds ${MAX_TOTAL_MB} MB.` };
        }
        return { ok: true };
      }

      input.addEventListener('change', (e) => {
        const files = e.target.files;
        const v = validateFiles(files);
        if (!v.ok) {
          alert(v.message);
          input.value = '';
          clearPreviews();
          return;
        }
        renderPreviews(files);
      });

      form.addEventListener('submit', () => {
        loader.hidden = false;
        loader.style.display = 'flex';
      });

      // Drag & drop support
      ['dragenter', 'dragover'].forEach(evt =>
        dropZone.addEventListener(evt, (e) => {
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.add('dragging');
        })
      );
      ['dragleave', 'drop'].forEach(evt =>
        dropZone.addEventListener(evt, (e) => {
          e.preventDefault(); e.stopPropagation();
          dropZone.classList.remove('dragging');
        })
      );
      dropZone.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        if (!dt || !dt.files) return;
        const v = validateFiles(dt.files);
        if (!v.ok) return alert(v.message);
        input.files = dt.files;
        renderPreviews(dt.files);
      });

      // Keyboard focus style helper (optional)
      document.body.addEventListener('keydown', (e) => {
        if (e.key === 'Tab') document.body.classList.add('user-is-tabbing');
      }, { once: true });
    })();
  </script>
</body>
</html>
