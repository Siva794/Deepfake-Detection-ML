<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deepfake Detector</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    /* Minimal inline hardening so it looks fine without style.css */
    body { font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; }
    .navbar { padding: 12px 16px; border-bottom: 1px solid #eee; }
    .nav-title { font-weight:700; }
    .container { max-width: 980px; margin: 32px auto; padding: 0 16px; }
    .subtitle { font-weight:500; opacity:.85 }
    form { margin: 16px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .upload-box { border:2px dashed #ccc; padding:16px; border-radius:10px; cursor:pointer; flex: 1; text-align:center; }
    #detectBtn { padding:12px 16px; border:0; border-radius:10px; cursor:pointer; }
    .preview-grid, .results-grid { display:grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap:12px; margin-top:16px; }
    .preview-card, .result-card { border:1px solid #eee; border-radius:10px; overflow:hidden; background:#fff; }
    .preview-card img, .result-card img { width:100%; height:180px; object-fit:cover; display:block; }
    .label { padding:8px 10px; font-weight:600; }
    .label.real { color:#0a7d2b; }
    .label.fake { color:#b00020; }
    .conf { padding:0 10px 10px; font-size:.9rem; opacity:.8; }
    .loader { display:none; align-items:center; gap:10px; margin-top:12px; }
    .spinner { width:18px; height:18px; border-radius:50%; border:3px solid #ddd; border-top-color:#000; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { color:#b00020; margin-top:12px; }
  </style>
</head>
<body>
  <nav class="navbar"><div class="nav-title">üß† Deepfake Detector</div></nav>

  <div class="container">
    <h2 class="subtitle">Detect if your image is AI-generated or real</h2>

    <form id="uploadForm">
      <label class="upload-box" for="file">
        <input type="file" id="file" name="file" accept="image/*" multiple required>
        <span id="uploadText">üìÅ Click or drag multiple images here</span>
      </label>
      <button type="submit" id="detectBtn">üîç Analyze Images</button>
    </form>

    <div id="previewContainer" class="preview-grid"></div>

    <div id="loader" class="loader">
      <div class="spinner"></div>
      <p>Analyzing images...</p>
    </div>

    <div id="errorBox" class="error"></div>

    <div id="resultsSection" class="results-section" style="display:none;">
      <h2>üîç Results</h2>
      <div id="resultsGrid" class="results-grid"></div>
    </div>
  </div>

  <script>
    // üëâ IMPORTANT: set this to your deployed Flask backend (must be HTTPS)
    const BACKEND_URL = "https://YOUR-BACKEND-URL"; // e.g. https://deepfake-detector.onrender.com

    const fileInput = document.getElementById('file');
    const previewContainer = document.getElementById('previewContainer');
    const uploadForm = document.getElementById('uploadForm');
    const loader = document.getElementById('loader');
    const errorBox = document.getElementById('errorBox');
    const resultsSection = document.getElementById('resultsSection');
    const resultsGrid = document.getElementById('resultsGrid');

    // Keep a list of previews in the same order as chosen files
    let previews = [];

    fileInput.addEventListener('change', async (e) => {
      previews = [];
      previewContainer.innerHTML = '';
      const files = e.target.files;
      if (!files || !files.length) return;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const url = await readAsDataURL(file);
        previews.push(url);

        const card = document.createElement('div');
        card.className = 'preview-card';
        card.innerHTML = `<img src="${url}" alt="preview">`;
        previewContainer.appendChild(card);
      }
    });

    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorBox.textContent = '';
      resultsSection.style.display = 'none';
      resultsGrid.innerHTML = '';

      const files = fileInput.files;
      if (!files || !files.length) {
        errorBox.textContent = 'No files selected.';
        return;
      }

      // POST to backend /predict
      const fd = new FormData();
      for (let i = 0; i < files.length; i++) fd.append('file', files[i]);

      loader.style.display = 'flex';
      try {
        const resp = await fetch(`${BACKEND_URL}/predict`, {
          method: 'POST',
          body: fd,
        });

        if (!resp.ok) {
          const msg = await safeError(resp);
          throw new Error(msg || `Request failed with status ${resp.status}`);
        }

        const data = await resp.json();
        if (!data || !Array.isArray(data.results)) {
          throw new Error('Unexpected response from server.');
        }

        // Render results matched to previews using the returned file "index"
        // If any indexes are missing (skipped invalid files), we just show those we have.
        const byIndex = new Map(data.results.map(r => [r.index, r]));
        resultsGrid.innerHTML = '';
        for (let i = 0; i < previews.length; i++) {
          const r = byIndex.get(i);
          if (!r) continue; // skipped invalid/unsupported files on server
          const labelClass = r.label.includes('Fake') ? 'fake' : 'real';
          const card = document.createElement('div');
          card.className = 'result-card';
          card.innerHTML = `
            <img src="${previews[i]}" alt="result">
            <div class="label ${labelClass}">${r.label}</div>
            <div class="conf">Real: ${r.real_conf}% | Fake: ${r.fake_conf}%</div>
          `;
          resultsGrid.appendChild(card);
        }
        resultsSection.style.display = 'block';

      } catch (err) {
        errorBox.textContent = err.message || 'Failed to analyze images.';
      } finally {
        loader.style.display = 'none';
      }
    });

    function readAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    async function safeError(resp) {
      try { const t = await resp.text(); return t; } catch { return null; }
    }
  </script>
</body>
</html>